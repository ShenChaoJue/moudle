# Java堆内存溢出解决方案

## 问题描述
应用程序出现 `java.lang.OutOfMemoryError: Java heap space` 错误。

## 解决方案

### 1. 立即解决（推荐）
使用提供的启动脚本：
- **Windows**: 双击 `startup.bat`
- **Linux/Mac**: 运行 `./startup.sh`

脚本已配置JVM参数：
- 初始堆内存：512MB
- 最大堆内存：2GB
- 使用G1垃圾收集器

### 2. Maven启动
```bash
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xms512m -Xmx2048m"
```

### 3. 直接Java命令启动
```bash
java -Xms512m -Xmx2048m -XX:+UseG1GC -jar target/moudle-0.0.1-SNAPSHOT.jar
```

### 4. IDE配置（IntelliJ IDEA）
1. Run → Edit Configurations
2. 选择你的Application配置
3. 在VM options中添加：`-Xms512m -Xmx2048m`

### 5. 生产环境配置
对于生产环境，建议更大的内存：
```bash
java -Xms1024m -Xmx4096m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -jar app.jar
```

## 性能优化建议

### 1. 文件上传优化
- 当前配置支持最大4GB文件上传
- 建议：对大文件（>100MB）启用分片上传
- 已在 `file.upload.auto-chunk.threshold=10485760` 配置

### 2. 数据库连接池优化
当前配置（application.yml）：
```yaml
hikari:
  minimum-idle: 5
  maximum-pool-size: 20
```
- 建议根据并发量调整
- 高并发场景：maximum-pool-size可设为50-100

### 3. JVM调优参数说明
- `-Xms512m`: 初始堆内存，避免动态分配的性能开销
- `-Xmx2048m`: 最大堆内存，防止OutOfMemoryError
- `-XX:+UseG1GC`: G1垃圾收集器，适合大堆内存
- `-XX:MaxGCPauseMillis=200`: GC暂停时间目标
- `-XX:+UseStringDeduplication`: 字符串去重，减少内存占用

## 监控和诊断

### 1. 内存使用监控
启动时添加：
```bash
-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/dump.hprof
```

### 2. JMX监控
```bash
-Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false
```

### 3. GC日志
```bash
-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:/tmp/gc.log
```

## 长期优化建议

1. **代码层面**：
   - 及时释放大对象引用
   - 使用对象池复用频繁创建的对象
   - 对大文件使用流式处理，避免一次性加载到内存

2. **架构层面**：
   - 考虑使用消息队列处理大文件
   - 实施缓存策略
   - 考虑分布式架构

3. **运维层面**：
   - 设置内存监控告警
   - 定期分析GC日志
   - 实施蓝绿部署或滚动更新

## 验证方案
1. 重启应用（使用提供的启动脚本）
2. 上传一个大文件测试
3. 观察控制台是否有内存溢出错误
4. 使用JVisualVM或类似工具监控内存使用情况
