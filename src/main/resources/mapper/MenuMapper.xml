<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ziwen.moudle.mapper.rbac.MenuMapper">

    <resultMap id="BaseResultMap" type="com.ziwen.moudle.entity.rbac.Menu">
        <id column="id" property="id"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="menu_name" property="menuName"/>
        <result column="url" property="url"/>
        <result column="path" property="path"/>
        <result column="type" property="type"/>
        <result column="parent_id" property="parentId"/>
        <result column="child_id" property="childId"/>
        <result column="sort" property="sort"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, create_time, update_time, create_by, update_by,
        menu_name, url, path, type, parent_id, child_id, sort, is_deleted
    </sql>

    <!-- 查询所有菜单 -->
    <select id="selectAllMenus" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE is_deleted = 0
        ORDER BY sort ASC, id ASC
    </select>

    <!-- 查询菜单列表（带过滤条件） -->
    <select id="selectMenuList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE is_deleted = 0
        <if test="menuName != null and menuName != ''">
            AND menu_name LIKE CONCAT('%', #{menuName}, '%')
        </if>
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        ORDER BY sort ASC, id ASC
    </select>

    <!-- 根据菜单ID查询关联的角色ID列表 -->
    <select id="selectMenuRoleIds" resultType="java.lang.Long">
        SELECT rm.role_id
        FROM sys_role_menu rm
        WHERE rm.menu_id = #{menuId}
        AND rm.is_deleted = 0
    </select>

    <!-- 查询子菜单 -->
    <select id="selectChildren" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE parent_id = #{parentId}
        AND is_deleted = 0
        ORDER BY sort ASC, id ASC
    </select>

    <!-- 根据用户ID查询用户菜单权限 -->
    <select id="selectMenusByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT
        <include refid="Base_Column_List"/>
        FROM sys_menu m
        INNER JOIN sys_role_menu rm ON m.id = rm.menu_id AND rm.is_deleted = 0
        INNER JOIN sys_user_role ur ON rm.role_id = ur.role_id AND ur.is_deleted = 0
        WHERE ur.user_id = #{userId}
        AND m.is_deleted = 0
        ORDER BY sort ASC, id ASC
    </select>

    <!-- 查询所有菜单路径 -->
    <select id="selectAllMenuPaths" resultType="java.lang.String">
        SELECT DISTINCT path
        FROM sys_menu
        WHERE is_deleted = 0
        AND path IS NOT NULL AND path != ''
    </select>

    <!-- 检查菜单名称是否存在 -->
    <select id="checkMenuNameExists" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM sys_menu
        WHERE is_deleted = 0
        AND menu_name = #{menuName}
        AND parent_id = #{parentId}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 根据ID查询菜单 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_menu
        WHERE id = #{id}
        AND is_deleted = 0
    </select>

    <!-- 插入菜单 -->
    <insert id="insert" parameterType="com.ziwen.moudle.entity.rbac.Menu">
        INSERT INTO sys_menu
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="menuName != null">menu_name</if>
            <if test="url != null">url</if>
            <if test="path != null">path</if>
            <if test="type != null">type</if>
            <if test="parentId != null">parent_id</if>
            <if test="childId != null">child_id</if>
            <if test="sort != null">sort</if>
            <if test="createTime != null">create_time</if>
            <if test="updateTime != null">update_time</if>
            <if test="createBy != null">create_by</if>
            <if test="updateBy != null">update_by</if>
            <if test="isDeleted != null">is_deleted</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="menuName != null">#{menuName}</if>
            <if test="url != null">#{url}</if>
            <if test="path != null">#{path}</if>
            <if test="type != null">#{type}</if>
            <if test="parentId != null">#{parentId}</if>
            <if test="childId != null">#{childId}</if>
            <if test="sort != null">#{sort}</if>
            <if test="createTime != null">#{createTime}</if>
            <if test="updateTime != null">#{updateTime}</if>
            <if test="createBy != null">#{createBy}</if>
            <if test="updateBy != null">#{updateBy}</if>
            <if test="isDeleted != null">#{isDeleted}</if>
        </trim>
    </insert>

    <!-- 根据ID更新菜单 -->
    <update id="updateById" parameterType="com.ziwen.moudle.entity.rbac.Menu">
        UPDATE sys_menu
        <set>
            <if test="menuName != null">menu_name = #{menuName},</if>
            <if test="url != null">url = #{url},</if>
            <if test="path != null">path = #{path},</if>
            <if test="type != null">type = #{type},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="childId != null">child_id = #{childId},</if>
            <if test="sort != null">sort = #{sort},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
        </set>
        WHERE id = #{id}
    </update>
</mapper>
