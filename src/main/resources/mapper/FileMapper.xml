<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ziwen.moudle.mapper.file.FileMapper">

    <!-- 结果集映射 -->
    <resultMap id="BaseResultMap" type="com.ziwen.moudle.entity.file.FileEntity">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="original_name" property="originalName" jdbcType="VARCHAR"/>
        <result column="content_type" property="contentType" jdbcType="VARCHAR"/>
        <result column="file_size" property="fileSize" jdbcType="BIGINT"/>
        <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
        <result column="access_path" property="accessPath" jdbcType="VARCHAR"/>
        <result column="upload_time" property="uploadTime" jdbcType="TIMESTAMP"/>
        <result column="is_chunked" property="isChunked" jdbcType="BIT"/>
        <result column="total_chunks" property="totalChunks" jdbcType="INTEGER"/>
        <result column="chunk_size" property="chunkSize" jdbcType="BIGINT"/>
        <result column="upload_id" property="uploadId" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, create_time, update_time, is_deleted, original_name, content_type, file_size,
        file_path, access_path, upload_time, is_chunked, total_chunks, chunk_size, upload_id
    </sql>

    <!-- 查询文件列表 -->
    <select id="selectFileList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_file
        WHERE is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据ID查询文件 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_file
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 插入文件 -->
    <insert id="insert" parameterType="com.ziwen.moudle.entity.file.FileEntity">
        INSERT INTO sys_file (
            id, create_time, update_time, is_deleted,
            original_name, content_type, file_size,
            file_path, access_path, upload_time,
            is_chunked, total_chunks, chunk_size, upload_id
        ) VALUES (
            #{id,jdbcType=BIGINT},
            NOW(), NOW(), COALESCE(#{isDeleted}, 0),
            #{originalName}, #{contentType}, #{fileSize},
            #{filePath}, #{accessPath}, COALESCE(#{uploadTime}, NOW()),
            COALESCE(#{isChunked}, 0),
            COALESCE(#{totalChunks}, 0),
            COALESCE(#{chunkSize}, 0),
            COALESCE(#{uploadId}, '')
        )
    </insert>

    <!-- 根据ID更新文件 -->
    <update id="updateById" parameterType="com.ziwen.moudle.entity.file.FileEntity">
        UPDATE sys_file
        <set>
            update_time = NOW(),
            <if test="originalName != null">original_name = #{originalName},</if>
            <if test="contentType != null">content_type = #{contentType},</if>
            <if test="fileSize != null">file_size = #{fileSize},</if>
            <if test="filePath != null">file_path = #{filePath},</if>
            <if test="accessPath != null">access_path = #{accessPath},</if>
            <if test="uploadTime != null">upload_time = #{uploadTime},</if>
            <if test="isChunked != null">is_chunked = #{isChunked},</if>
            <if test="totalChunks != null">total_chunks = #{totalChunks},</if>
            <if test="chunkSize != null">chunk_size = #{chunkSize},</if>
            <if test="uploadId != null">upload_id = #{uploadId},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted}</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除文件（软删除） -->
    <update id="deleteById" parameterType="java.lang.Long">
        UPDATE sys_file
        SET update_time = NOW(), is_deleted = 1
        WHERE id = #{id} AND is_deleted = 0
    </update>

</mapper>
